import requests
import json
from datetime import datetime, timedelta
import time

class SimpleStockAnalyzer:
    def __init__(self):
        """ê°„ë‹¨í•œ ì£¼ì‹ ë¶„ì„ ì‹œìŠ¤í…œ (ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìµœì†Œí™”)"""
        self.sp500_companies = {
            'AAPL': {'name': 'Apple Inc.', 'sector': 'Technology'},
            'MSFT': {'name': 'Microsoft Corporation', 'sector': 'Technology'}, 
            'NVDA': {'name': 'NVIDIA Corporation', 'sector': 'Technology'},
            'AMZN': {'name': 'Amazon.com Inc.', 'sector': 'Consumer Discretionary'},
            'GOOGL': {'name': 'Alphabet Inc.', 'sector': 'Technology'},
            'META': {'name': 'Meta Platforms Inc.', 'sector': 'Technology'},
            'TSLA': {'name': 'Tesla Inc.', 'sector': 'Consumer Discretionary'},
            'JPM': {'name': 'JPMorgan Chase & Co.', 'sector': 'Financial Services'},
            'JNJ': {'name': 'Johnson & Johnson', 'sector': 'Healthcare'},
            'V': {'name': 'Visa Inc.', 'sector': 'Financial Services'},
            'PG': {'name': 'Procter & Gamble Co.', 'sector': 'Consumer Staples'},
            'UNH': {'name': 'UnitedHealth Group Inc.', 'sector': 'Healthcare'},
            'HD': {'name': 'Home Depot Inc.', 'sector': 'Consumer Discretionary'},
            'PLTR': {'name': 'Palantir Technologies Inc.', 'sector': 'Technology'}
        }
        
        # ëª¨ì˜ ë°ì´í„° (ì‹¤ì œ API ëŒ€ì‹  ì‚¬ìš©)
        self.mock_data = self.generate_mock_data()
    
    def generate_mock_data(self):
        """ëª¨ì˜ ì£¼ì‹ ë°ì´í„° ìƒì„±"""
        import random
        
        mock_data = {}
        base_prices = {
            'AAPL': 199.20, 'MSFT': 450.00, 'NVDA': 145.00, 'AMZN': 185.00,
            'GOOGL': 175.00, 'META': 520.00, 'TSLA': 250.00, 'JPM': 210.00,
            'JNJ': 160.00, 'V': 280.00, 'PG': 165.00, 'UNH': 590.00,
            'HD': 390.00, 'PLTR': 135.19
        }
        
        for symbol, info in self.sp500_companies.items():
            base_price = base_prices.get(symbol, 100.00)
            change_pct = random.uniform(-5.0, 8.0)  # -5% ~ +8% ë³€ë™
            current_price = base_price * (1 + change_pct/100)
            
            mock_data[symbol] = {
                'name': info['name'],
                'sector': info['sector'],
                'current_price': round(current_price, 2),
                'change_pct': round(change_pct, 2),
                'volume': random.randint(1000000, 50000000),
                'market_cap': random.randint(100, 3000) * 1e9,
                'pe_ratio': round(random.uniform(15, 45), 1),
                'dividend_yield': round(random.uniform(0, 4), 2),
                'beta': round(random.uniform(0.5, 2.0), 2),
                'recommendation': random.choice(['BUY', 'HOLD', 'SELL', 'STRONG_BUY'])
            }
        
        return mock_data
    
    def display_stock_data(self):
        """ì£¼ì‹ ë°ì´í„° í‘œì‹œ"""
        print("ğŸ“Š S&P 500 ì£¼ìš” ì¢…ëª© í˜„í™©")
        print("=" * 100)
        print(f"{'ì¢…ëª©':^8} {'íšŒì‚¬ëª…':^25} {'í˜„ì¬ê°€':^10} {'ë“±ë½ë¥ ':^8} {'ì„¹í„°':^20} {'ì¶”ì²œ':^10}")
        print("-" * 100)
        
        for symbol, data in self.mock_data.items():
            color = "ğŸŸ¢" if data['change_pct'] > 0 else "ğŸ”´" if data['change_pct'] < 0 else "âšª"
            print(f"{symbol:^8} {data['name'][:23]:^25} ${data['current_price']:^8.2f} "
                  f"{color}{data['change_pct']:^6.2f}% {data['sector'][:18]:^20} {data['recommendation']:^10}")
    
    def analyze_top_performers(self, top_n=5):
        """ìƒìœ„ ì„±ê³¼ ì¢…ëª© ë¶„ì„"""
        # ë“±ë½ë¥  ê¸°ì¤€ ì •ë ¬
        sorted_stocks = sorted(self.mock_data.items(), 
                             key=lambda x: x[1]['change_pct'], reverse=True)
        
        print(f"\nğŸ† ìƒìœ„ {top_n}ê°œ ì„±ê³¼ ì¢…ëª©")
        print("=" * 80)
        
        for i, (symbol, data) in enumerate(sorted_stocks[:top_n], 1):
            print(f"{i}. {symbol} - {data['name']}")
            print(f"   ğŸ’° í˜„ì¬ê°€: ${data['current_price']:,.2f}")
            print(f"   ğŸ“ˆ ë“±ë½ë¥ : {data['change_pct']:+.2f}%")
            print(f"   ğŸ¢ ì„¹í„°: {data['sector']}")
            print(f"   ğŸ“Š ë² íƒ€: {data['beta']}")
            print(f"   ğŸ¯ ì¶”ì²œ: {data['recommendation']}")
            print(f"   ğŸ’¹ ì‹œê°€ì´ì•¡: ${data['market_cap']/1e9:.1f}B")
            print("-" * 50)
        
        return sorted_stocks[:top_n]
    
    def sector_analysis(self):
        """ì„¹í„°ë³„ ë¶„ì„"""
        sectors = {}
        
        for symbol, data in self.mock_data.items():
            sector = data['sector']
            if sector not in sectors:
                sectors[sector] = {'stocks': [], 'total_change': 0, 'count': 0, 'total_cap': 0}
            
            sectors[sector]['stocks'].append(symbol)
            sectors[sector]['total_change'] += data['change_pct']
            sectors[sector]['count'] += 1
            sectors[sector]['total_cap'] += data['market_cap']
        
        print(f"\nğŸ­ ì„¹í„°ë³„ ì„±ê³¼ ë¶„ì„")
        print("=" * 80)
        
        for sector, info in sectors.items():
            avg_change = info['total_change'] / info['count']
            total_cap = info['total_cap'] / 1e12  # ì¡° ë‹¬ëŸ¬ ë‹¨ìœ„
            
            print(f"ğŸ“‹ {sector}")
            print(f"   ğŸ“ˆ í‰ê·  ë“±ë½ë¥ : {avg_change:+.2f}%")
            print(f"   ğŸ¢ ì¢…ëª© ìˆ˜: {info['count']}ê°œ")
            print(f"   ğŸ’° ì´ ì‹œê°€ì´ì•¡: ${total_cap:.2f}T")
            print(f"   ğŸ¯ ëŒ€í‘œ ì¢…ëª©: {', '.join(info['stocks'][:3])}")
            print("-" * 50)
        
        return sectors
    
    def investment_recommendation(self, amount=100000, risk_profile='moderate'):
        """íˆ¬ì ì¶”ì²œ"""
        print(f"\nğŸ¯ íˆ¬ì ì¶”ì²œ (${amount:,}, {risk_profile} ì„±í–¥)")
        print("=" * 80)
        
        # ìœ„í—˜ì„±í–¥ë³„ í•„í„°ë§
        candidates = []
        
        for symbol, data in self.mock_data.items():
            score = 0
            
            if risk_profile == 'aggressive':
                # ê³ ìœ„í—˜ ê³ ìˆ˜ìµ: ë†’ì€ ë² íƒ€, ê¸°ìˆ ì£¼ ì„ í˜¸
                if data['beta'] > 1.5: score += 3
                if data['sector'] == 'Technology': score += 2
                if data['change_pct'] > 3: score += 2
                
            elif risk_profile == 'conservative':
                # ì €ìœ„í—˜ ì•ˆì •í˜•: ë‚®ì€ ë² íƒ€, ë°°ë‹¹ ì„ í˜¸
                if data['beta'] < 1.0: score += 3
                if data['dividend_yield'] > 2: score += 2
                if data['sector'] in ['Healthcare', 'Consumer Staples']: score += 2
                
            else:  # moderate
                # ê· í˜•í˜•: ì ë‹¹í•œ ìœ„í—˜, ì„¹í„° ë¶„ì‚°
                if 1.0 <= data['beta'] <= 1.5: score += 2
                if data['pe_ratio'] < 30: score += 1
                if data['recommendation'] in ['BUY', 'STRONG_BUY']: score += 2
            
            candidates.append((symbol, data, score))
        
        # ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬
        candidates.sort(key=lambda x: x[2], reverse=True)
        
        # ìƒìœ„ 5ê°œ ì¢…ëª©ìœ¼ë¡œ í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„±
        allocation_pct = [0.3, 0.25, 0.2, 0.15, 0.1]
        portfolio = {}
        
        print("ğŸ“‹ ì¶”ì²œ í¬íŠ¸í´ë¦¬ì˜¤:")
        
        for i, (symbol, data, score) in enumerate(candidates[:5]):
            allocation = allocation_pct[i] if i < len(allocation_pct) else 0.1
            investment_value = amount * allocation
            shares = int(investment_value / data['current_price'])
            actual_investment = shares * data['current_price']
            
            portfolio[symbol] = {
                'shares': shares,
                'investment': actual_investment,
                'allocation': allocation * 100
            }
            
            print(f"\n{i+1}. {symbol} - {data['name']}")
            print(f"   ğŸ’° íˆ¬ìê¸ˆì•¡: ${actual_investment:,.2f} ({allocation*100:.1f}%)")
            print(f"   ğŸ“Š ì£¼ì‹ ìˆ˜: {shares:,}ì£¼")
            print(f"   ğŸ’µ ì£¼ê°€: ${data['current_price']:,.2f}")
            print(f"   ğŸ“ˆ ë“±ë½ë¥ : {data['change_pct']:+.2f}%")
            print(f"   ğŸ¢ ì„¹í„°: {data['sector']}")
            print(f"   ğŸ¯ ì ìˆ˜: {score}ì ")
        
        total_invested = sum(p['investment'] for p in portfolio.values())
        cash_remaining = amount - total_invested
        
        print(f"\nğŸ’° ì´ íˆ¬ìê¸ˆì•¡: ${total_invested:,.2f}")
        print(f"ğŸ’µ ì—¬ìœ  í˜„ê¸ˆ: ${cash_remaining:,.2f}")
        
        return portfolio
    
    def market_summary(self):
        """ì‹œì¥ ì „ì²´ ìš”ì•½"""
        total_stocks = len(self.mock_data)
        positive_stocks = sum(1 for data in self.mock_data.values() if data['change_pct'] > 0)
        negative_stocks = sum(1 for data in self.mock_data.values() if data['change_pct'] < 0)
        
        avg_change = sum(data['change_pct'] for data in self.mock_data.values()) / total_stocks
        total_market_cap = sum(data['market_cap'] for data in self.mock_data.values())
        
        print(f"\nğŸ“Š ì‹œì¥ ì „ì²´ ìš”ì•½")
        print("=" * 50)
        print(f"ğŸ“ˆ ìƒìŠ¹ ì¢…ëª©: {positive_stocks}ê°œ ({positive_stocks/total_stocks*100:.1f}%)")
        print(f"ğŸ“‰ í•˜ë½ ì¢…ëª©: {negative_stocks}ê°œ ({negative_stocks/total_stocks*100:.1f}%)")
        print(f"ğŸ“Š í‰ê·  ë“±ë½ë¥ : {avg_change:+.2f}%")
        print(f"ğŸ’° ì´ ì‹œê°€ì´ì•¡: ${total_market_cap/1e12:.2f}T")
        
        # ì„¹í„°ë³„ ìš”ì•½
        sectors = {}
        for data in self.mock_data.values():
            sector = data['sector']
            if sector not in sectors:
                sectors[sector] = 0
            sectors[sector] += 1
        
        print(f"\nğŸ­ ì„¹í„°ë³„ ì¢…ëª© ìˆ˜:")
        for sector, count in sectors.items():
            print(f"   {sector}: {count}ê°œ")
    
    def run_analysis(self):
        """ì „ì²´ ë¶„ì„ ì‹¤í–‰"""
        try:
            print("ğŸš€ S&P 500 ë¹…ë°ì´í„° ë¶„ì„ ì‹œì‘")
            print(f"â° ë¶„ì„ ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
            print("=" * 100)
            
            # 1. ì „ì²´ ë°ì´í„° í‘œì‹œ
            self.display_stock_data()
            
            # 2. ì‹œì¥ ìš”ì•½
            self.market_summary()
            
            # 3. ìƒìœ„ ì„±ê³¼ ì¢…ëª©
            self.analyze_top_performers()
            
            # 4. ì„¹í„° ë¶„ì„
            self.sector_analysis()
            
            # 5. íˆ¬ì ì¶”ì²œ (3ê°€ì§€ ìœ í˜•)
            self.investment_recommendation(100000, 'aggressive')
            self.investment_recommendation(100000, 'moderate')
            self.investment_recommendation(100000, 'conservative')
            
            print(f"\nâœ… ë¶„ì„ ì™„ë£Œ!")
            print("=" * 100)
            
        except Exception as e:
            print(f"âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

# ë©”ì¸ ì‹¤í–‰
if __name__ == "__main__":
    print("ğŸ¯ S&P 500 ë¹…ë°ì´í„° ë¶„ì„ ì‹œìŠ¤í…œ")
    print("1. ì „ì²´ ë¶„ì„ ì‹¤í–‰")
    print("2. ìƒìœ„ ì„±ê³¼ ì¢…ëª©ë§Œ")
    print("3. ì„¹í„° ë¶„ì„ë§Œ") 
    print("4. íˆ¬ì ì¶”ì²œë§Œ")
    
    try:
        choice = input("ì„ íƒí•˜ì„¸ìš” (1-4): ").strip()
        
        analyzer = SimpleStockAnalyzer()
        
        if choice == "1":
            analyzer.run_analysis()
        elif choice == "2":
            analyzer.display_stock_data()
            analyzer.analyze_top_performers()
        elif choice == "3":
            analyzer.sector_analysis()
        elif choice == "4":
            risk = input("ìœ„í—˜ì„±í–¥ (aggressive/moderate/conservative): ").strip()
            if risk not in ['aggressive', 'moderate', 'conservative']:
                risk = 'moderate'
            
            try:
                amount = int(input("íˆ¬ìê¸ˆì•¡ ($): ") or 100000)
            except:
                amount = 100000
                
            analyzer.investment_recommendation(amount, risk)
        else:
            print("âŒ ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤.")
            
    except KeyboardInterrupt:
        print("\nğŸ‘‹ í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
